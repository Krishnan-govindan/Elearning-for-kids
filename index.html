<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kid Speak & Learn</title>
  <style>
    /* Existing CSS styles omitted for brevity ... */

    /* New Styles for Loading Bar */
    #loadingBarContainer {
      display: none;              /* Hidden by default, shown during loading */
      margin-top: 1em;
    }
    #loadingBar {
      width: 100%;
      background-color: #28a745;  /* Green background (bootstrap .bg-success color) */
      color: #fff;
      text-align: center;
      padding: 0.5em 0;
      /* Optional: animated stripes */
      background-image: repeating-linear-gradient(
        45deg,
        rgba(255,255,255,0.2) 0 10px,
        transparent 10px 20px
      );
      background-size: 20px 20px;
      animation: progressAnim 1s linear infinite;
    }
    @keyframes progressAnim {
      0% { background-position: 0 0; }
      100% { background-position: 20px 20px; }
    }
    /* Hide transcript/answer/audio initially (or use a CSS class like .hidden) */
    #transcript, #answer, #audioPlayer {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Kid Speak & Learn</h1>

  <!-- Language selection (existing feature) -->
  <label for="languageSelect">Answer language:</label>
  <select id="languageSelect">
    <!-- Options ... -->
    <option value="en">English</option>
    <option value="ta">Tamil</option>
    <!-- etc. -->
  </select>

  <!-- Recording controls -->
  <button id="recordBtn">ðŸŽ¤ Start Recording</button>
  <button id="stopBtn" disabled>Stop</button>
  <button id="sendBtn" disabled>Send</button>

  <!-- Loading indicator (hidden until Send is clicked) -->
  <div id="loadingBarContainer">
    <div id="loadingBar">ðŸ”„ We are preparing your answers...</div>
  </div>

  <!-- Result display (initially hidden or empty) -->
  <p id="transcript"><strong>Transcript:</strong> <span id="transcriptText">--</span></p>
  <p id="answer"><strong>Answer:</strong> <span id="answerText">--</span></p>
  <audio id="audioPlayer" controls></audio>

  <script>
    // JavaScript for recording and sending

    let mediaRecorder;
    let audioChunks = [];
    let currentStream = null;

    // Get microphone permission and stream upfront (to avoid delay on first click)
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        currentStream = stream;
        mediaRecorder = new MediaRecorder(stream);
        // Capture audio data
        mediaRecorder.ondataavailable = e => {
          if (e.data.size > 0) {
            audioChunks.push(e.data);
          }
        };
        // When recording stops, assemble the audio blob
        mediaRecorder.onstop = () => {
          // Enable Send button now that we have a recording
          sendBtn.disabled = false;
          // Reset record button text for next recording session
          recordBtn.textContent = "ðŸŽ¤ Start Recording";
        };
      })
      .catch(err => {
        console.error("Microphone access error:", err);
        alert("Could not access microphone. Please check permissions.");
      });

    // Record/Pause/Resume button logic
    recordBtn.addEventListener("click", () => {
      if (!mediaRecorder) return;  // if mediaRecorder not initialized
      if (mediaRecorder.state === "inactive") {
        // Start a new recording
        audioChunks = [];  // reset previous chunks
        mediaRecorder.start();
        recordBtn.textContent = "â¸ Pause";
        stopBtn.disabled = false;
        sendBtn.disabled = true;   // disable send until recording is stopped
      } else if (mediaRecorder.state === "recording") {
        // Pause the ongoing recording
        mediaRecorder.pause();
        recordBtn.textContent = "â–¶ï¸ Resume";
      } else if (mediaRecorder.state === "paused") {
        // Resume the paused recording
        mediaRecorder.resume();
        recordBtn.textContent = "â¸ Pause";
      }
    });

    // Stop button logic
    stopBtn.addEventListener("click", () => {
      if (mediaRecorder && (mediaRecorder.state === "recording" || mediaRecorder.state === "paused")) {
        mediaRecorder.stop();
        stopBtn.disabled = true;
        // After stopping, recordBtn will be reset in onstop handler
      }
    });

    // Send button logic â€“ sending the recorded audio to the server
    sendBtn.addEventListener("click", async () => {
      if (audioChunks.length === 0) return;  // nothing to send
      // Show loading indicator and hide previous results
      document.getElementById("loadingBarContainer").style.display = "block";
      document.getElementById("transcript").style.display = "none";
      document.getElementById("answer").style.display = "none";
      document.getElementById("audioPlayer").style.display = "none";

      // Prepare the audio blob to send
      const audioBlob = new Blob(audioChunks, { type: "audio/webm" });  // or "audio/wav" depending on API
      const formData = new FormData();
      formData.append("file", audioBlob, "recording.webm");
      formData.append("language", languageSelect.value);  // include selected language if needed

      try {
        // POST to the Render.com API endpoint (replace URL with actual endpoint)
        const response = await fetch("<YOUR_RENDER_API_ENDPOINT>", {
          method: "POST",
          body: formData
        });
        const result = await response.json();
        // Hide loading bar
        document.getElementById("loadingBarContainer").style.display = "none";
        // Show transcript and answer text
        document.getElementById("transcriptText").textContent = result.transcript || "(No transcript)";
        document.getElementById("answerText").textContent = result.answer || "(No answer)";
        document.getElementById("transcript").style.display = "block";
        document.getElementById("answer").style.display = "block";
        // Prepare audio playback of the answer (if provided by API)
        if (result.audioUrl) {
          const audioPlayer = document.getElementById("audioPlayer");
          audioPlayer.src = result.audioUrl;
          audioPlayer.style.display = "block";
          audioPlayer.play().catch(e => console.warn("Auto-play blocked or failed:", e));
        }
      } catch (error) {
        console.error("Error during fetch:", error);
        alert("Sorry, something went wrong while preparing the answer.");
        // Hide loading bar even on error
        document.getElementById("loadingBarContainer").style.display = "none";
      }
    });
  </script>
</body>
</html>
