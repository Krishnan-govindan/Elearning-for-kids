<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Kid Speak & Learn</title>
    <style>
      :root { --card:#fff; --ink:#111; --muted:#666; --bd:#e5e7eb; --bg:#f8fafc; }
      * { box-sizing: border-box }
      body { margin:0; font-family: system-ui, Segoe UI, Roboto, Arial; background: var(--bg); color: var(--ink) }
      .wrap { max-width: 760px; margin: 2rem auto; background: var(--card); padding: 1.5rem; border:1px solid var(--bd); border-radius: 16px; }
      h1 { margin: 0 0 1rem }
      .row { display:flex; gap:.75rem; align-items:center; flex-wrap:wrap }
      select, button { padding:.8rem 1.1rem; border-radius:12px; border:1px solid var(--bd); background:#fff }
      button { cursor:pointer; font-weight:600 }
      button.primary { background:#111; color:#fff; }
      button.ghost { background:#fff; }
      button[disabled] { opacity:.55; cursor:not-allowed }
      .status { color: var(--muted); margin:.5rem 0 1rem }
      audio { width:100%; margin-top:.75rem }
      .box { background:#fafafa; border:1px dashed var(--bd); border-radius:12px; padding:.75rem; margin-top:.5rem }
      b { font-weight:600 }
      .pill { padding:.3rem .6rem; border-radius:999px; background:#eef2ff; border:1px solid #c7d2fe; font-size:.85rem }
      #loadingBar {
        display: none;
        width: 100%;
        padding: 0.6rem;
        background-color: #4CAF50;
        color: #fff;
        text-align: center;
        border-radius: 8px;
        margin-top: 0.5rem;
        font-weight: 600;
      }
      .spacer { flex: 1 1 auto }
      .subtle { color: var(--muted); font-size: .9rem; }
      .chip { padding:.25rem .6rem; border:1px solid var(--bd); border-radius:999px; background:#fff; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Kid Speak & Learn</h1>

      <div class="row">
        <label><b>Speaking language</b><br/>
          <select id="speakLang" required>
            <option value="">Select language</option>
            <option>English</option>
            <option>Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
            <option>Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)</option>
            <option>Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
            <option>Kannada (‡≤ï‡≤®‡≥ç‡≤®‡≤°)</option>
            <option>Malayalam (‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç)</option>
            <option>Marathi (‡§Æ‡§∞‡§æ‡§†‡•Ä)</option>
            <option>Gujarati (‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä)</option>
            <option>Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)</option>
            <option>Panjabi (‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä)</option>
          </select>
        </label>

        <label><b>Answer language</b><br/>
          <select id="answerLang" required>
            <option value="">Select language</option>
            <option>English</option>
            <option>Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
            <option>Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)</option>
            <option>Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
            <option>Kannada (‡≤ï‡≤®‡≥ç‡≤®‡≤°)</option>
            <option>Malayalam (‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç)</option>
            <option>Marathi (‡§Æ‡§∞‡§æ‡§†‡•Ä)</option>
            <option>Gujarati (‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä)</option>
            <option>Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)</option>
            <option>Panjabi (‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä)</option>
          </select>
        </label>

        <span class="spacer"></span>

        <button id="newChatBtn" class="chip">üÜï New chat</button>
      </div>

      <div class="row" style="margin-top:.5rem;">
        <button id="recordBtn" class="ghost" disabled>üéôÔ∏è Start recording</button>
        <button id="pauseBtn" class="ghost" hidden disabled>‚è∏ Pause</button>
        <button id="sendBtn" class="primary" disabled>‚Üó Send</button>
        <span id="timer" class="pill" hidden>00:00</span>
      </div>

      <div class="status subtle" id="status">Choose both languages ‚Üí tap <b>Start recording</b>, then tap <b>Send</b>.</div>
      <div id="loadingBar">We are preparing your answers‚Ä¶</div>

      <div class="box" id="transcriptBox"><b>Transcript:</b> <span id="transcript">‚Äî</span></div>
      <div class="box" id="answerBox"><b>Answer:</b> <span id="answer">‚Äî</span></div>
      <audio id="player" controls></audio>
    </div>

    <script>
      const API_BASE = "https://india-therapist-chatbot.onrender.com";

      const recordBtn = document.getElementById('recordBtn');
      const pauseBtn  = document.getElementById('pauseBtn');
      const sendBtn   = document.getElementById('sendBtn');
      const newChatBtn= document.getElementById('newChatBtn');
      const statusEl  = document.getElementById('status');
      const transcriptEl = document.getElementById('transcript');
      const answerEl     = document.getElementById('answer');
      const player       = document.getElementById('player');
      const speakLangSel = document.getElementById('speakLang');
      const answerLangSel= document.getElementById('answerLang');
      const timerBadge   = document.getElementById('timer');
      const transcriptBox= document.getElementById('transcriptBox');
      const answerBox    = document.getElementById('answerBox');
      const loadingBar   = document.getElementById('loadingBar');

      // ---- conversation id (persist per tab) ----
      let conversationId = localStorage.getItem("kidchat_id") || crypto.randomUUID();
      localStorage.setItem("kidchat_id", conversationId);

      function resetUIForNewChat() {
        transcriptEl.textContent = "‚Äî";
        answerEl.textContent = "‚Äî";
        player.removeAttribute('src');
        player.load();
        transcriptBox.style.display = '';
        answerBox.style.display = '';
        loadingBar.style.display = 'none';
        statusEl.textContent = 'New chat started. Choose languages, record, then send.';
        lastBlob = null;
        validateLangs();
      }

      newChatBtn.addEventListener('click', async () => {
        conversationId = crypto.randomUUID();
        localStorage.setItem("kidchat_id", conversationId);
        // tell server to clear (best effort)
        fetch(`${API_BASE}/api/new`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ conversationId })
        }).catch(()=>{});
        resetUIForNewChat();
      });

      let mediaRecorder, chunks = [], isRecording = false, startTs = 0, tickInt = null, lastBlob = null;

      function validateLangs() {
        const ok = speakLangSel.value && answerLangSel.value;
        recordBtn.disabled = !ok;
        sendBtn.disabled = !ok || !lastBlob;
        return ok;
      }
      speakLangSel.addEventListener('change', validateLangs);
      answerLangSel.addEventListener('change', validateLangs);

      async function getStream() {
        try { return await navigator.mediaDevices.getUserMedia({ audio: true }); }
        catch { alert("Microphone permission is required."); throw new Error("no-mic"); }
      }

      function fmt(sec){const m=String(Math.floor(sec/60)).padStart(2,'0');const s=String(Math.floor(sec%60)).padStart(2,'0');return `${m}:${s}`;}
      function startTimer(){timerBadge.hidden=false;startTs=Date.now();tickInt=setInterval(()=>{timerBadge.textContent=fmt((Date.now()-startTs)/1000);},250);}
      function stopTimer(){clearInterval(tickInt);tickInt=null;}

      async function toggleRecording() {
        if (!validateLangs()) { statusEl.textContent = "Please select both languages first."; return; }
        if (!isRecording) {
          statusEl.textContent = 'Recording‚Ä¶';
          const stream = await getStream();
          chunks = [];
          mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
          mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) chunks.push(e.data); };
          mediaRecorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'audio/webm' });
            lastBlob = blob;
            if (blob.size < 5000) {
              statusEl.textContent = 'Too short. Record at least 1 second.';
              sendBtn.disabled = true;
            } else {
              statusEl.textContent = 'Recording saved. Now tap ‚ÄúSend‚Äù.';
              sendBtn.disabled = !validateLangs();
            }
          };
          mediaRecorder.start();
          isRecording = true;
          recordBtn.textContent = "‚èπ Stop";
          pauseBtn.hidden = false; pauseBtn.disabled = false; pauseBtn.textContent = "‚è∏ Pause";
          startTimer();
        } else {
          stopTimer(); timerBadge.hidden = true;
          statusEl.textContent = 'Processing recording‚Ä¶';
          isRecording = false;
          recordBtn.textContent = "üéôÔ∏è Start recording";
          pauseBtn.hidden = true; pauseBtn.disabled = true;
          try { mediaRecorder.stop(); } catch {}
        }
      }
      recordBtn.addEventListener('click', toggleRecording);

      pauseBtn.addEventListener('click', () => {
        if (!mediaRecorder) return;
        if (mediaRecorder.state === 'recording') {
          mediaRecorder.pause();
          pauseBtn.textContent = "‚ñ∂Ô∏è Resume";
          statusEl.textContent = 'Paused. Resume or Stop.';
        } else if (mediaRecorder.state === 'paused') {
          mediaRecorder.resume();
          pauseBtn.textContent = "‚è∏ Pause";
          statusEl.textContent = 'Recording‚Ä¶';
        }
      });

      async function sendAudio() {
        if (!lastBlob) { statusEl.textContent = "Please record something first."; return; }
        if (!validateLangs()) { statusEl.textContent = "Please select both languages."; return; }

        // Hide results; show loader
        transcriptBox.style.display = 'none';
        answerBox.style.display = 'none';
        player.style.display = 'none';
        loadingBar.style.display = 'block';
        statusEl.textContent = "";

        const fd = new FormData();
        fd.append('audio', lastBlob, 'speech.webm');
        fd.append('speakLanguage',  speakLangSel.value);
        fd.append('answerLanguage', answerLangSel.value);
        fd.append('conversationId', conversationId);

        try {
          const res = await fetch(`${API_BASE}/api/ask`, { method: 'POST', body: fd });
          const json = await res.json();
          if (!res.ok) {
            loadingBar.style.display = 'none';
            const msg = json?.error === 'audio_too_short'
              ? 'Audio too short. Please record at least 1 second.'
              : (json?.message || json?.error || 'Request failed');
            statusEl.textContent = msg;
            return;
          }
          const { transcript, text, audioBase64 } = json;
          transcriptEl.textContent = transcript || '‚Äî';
          answerEl.textContent     = text || '‚Äî';
          player.src = 'data:audio/mpeg;base64,' + audioBase64;

          // Show results
          loadingBar.style.display = 'none';
          transcriptBox.style.display = '';
          answerBox.style.display   = '';
          player.style.display      = 'block';
          statusEl.textContent = 'Done! Ask a follow-up or start a New chat.';
        } catch (e) {
          console.error(e);
          loadingBar.style.display = 'none';
          statusEl.textContent = "Network error. Try again.";
        }
      }
      sendBtn.addEventListener('click', sendAudio);

      // initial state
      validateLangs();
    </script>
  </body>
</html>
