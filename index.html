<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Kid Speak & Learn</title>
    <style>
      :root { --card:#fff; --ink:#111; --muted:#666; --bd:#e5e7eb; --bg:#f8fafc; }
      * { box-sizing: border-box }
      body { margin:0; font-family: system-ui, Segoe UI, Roboto, Arial; background: var(--bg); color: var(--ink) }
      .wrap { max-width: 760px; margin: 2rem auto; background: var(--card); padding: 1.5rem; border:1px solid var(--bd); border-radius: 16px; }
      h1 { margin: 0 0 1rem }
      .row { display:flex; gap:.75rem; align-items:center; flex-wrap:wrap }
      select, button { padding:.8rem 1.1rem; border-radius:12px; border:1px solid var(--bd); background:#fff }
      button { cursor:pointer; font-weight:600 }
      button.rec { background:#eef2ff; border-color:#c7d2fe }
      .status { color: var(--muted); margin:.5rem 0 1rem }
      audio { width:100%; margin-top:.75rem }
      .box { background:#fafafa; border:1px dashed var(--bd); border-radius:12px; padding:.75rem; margin-top:.5rem }
      b { font-weight:600 }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Kid Speak & Learn</h1>
      <div class="row">
        <label for="lang"><b>Answer language</b></label>
        <select id="lang">
          <option>English</option>
          <option>Hindi</option>
          <option>Tamil</option>
          <option>Telugu</option>
          <option>Kannada</option>
          <option>Malayalam</option>
          <option>Marathi</option>
          <option>Gujarati</option>
          <option>Bengali</option>
          <option>Punjabi</option>
        </select>
        <button id="recBtn" class="rec">üéôÔ∏è Hold to speak</button>
      </div>

      <div class="status" id="status">Press and hold to record. Release to send.</div>

      <div class="box"><b>Transcript:</b> <span id="transcript">‚Äî</span></div>
      <div class="box"><b>Answer:</b> <span id="answer">‚Äî</span></div>
      <audio id="player" controls></audio>
    </div>

  <script>
  // IMPORTANT: point to your Render web service
  const API_BASE = "https://india-therapist-chatbot.onrender.com";

  const recBtn = document.getElementById('recBtn');
  const statusEl = document.getElementById('status');
  const transcriptEl = document.getElementById('transcript');
  const answerEl = document.getElementById('answer');
  const player = document.getElementById('player');
  const langSel = document.getElementById('lang');

  let mediaRecorder, chunks = [];

  async function getStream() {
    try { return await navigator.mediaDevices.getUserMedia({ audio: true }); }
    catch (e) { alert("Microphone permission is required."); throw e; }
  }

  recBtn.addEventListener('mousedown', async () => {
    statusEl.textContent = 'Recording... release to send';
    const stream = await getStream();
    chunks = [];
    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = async () => {
      statusEl.textContent = 'Processing...';
      const blob = new Blob(chunks, { type: 'audio/webm' });
      const fd = new FormData();
      fd.append('audio', blob, 'speech.webm');
      fd.append('targetLanguage', langSel.value);

      try {
        const res = await fetch(`${API_BASE}/api/ask`, { method: 'POST', body: fd });
        if (!res.ok) throw new Error('Request failed');
        const { transcript, text, audioBase64 } = await res.json();
        transcriptEl.textContent = transcript || '‚Äî';
        answerEl.textContent = text || '‚Äî';
        player.src = 'data:audio/mpeg;base64,' + audioBase64;
        statusEl.textContent = 'Done!';
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'Error. Try again.';
      }
    };
    mediaRecorder.start();
  });

  function stopIfRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      statusEl.textContent = 'Sending...';
      mediaRecorder.stop();
    }
  }

  recBtn.addEventListener('mouseup', stopIfRecording);
  recBtn.addEventListener('mouseleave', stopIfRecording);
  recBtn.addEventListener('touchstart', (e) => { e.preventDefault(); recBtn.dispatchEvent(new Event('mousedown')); }, {passive:false});
  recBtn.addEventListener('touchend', (e) => { e.preventDefault(); stopIfRecording(); }, {passive:false});
</script>
  </body>
</html>
